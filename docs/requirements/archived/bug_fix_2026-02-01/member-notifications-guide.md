# 会员通知功能指南

## 概述

会员可以接收两种类型的通知：
1. **线程消息** - 管理员在咨询对话中的回复
2. **直接消息** - 系统自动发送的通知

## 会员直接消息类型

### 1. 实绩审核结果通知

**触发时机**: 管理员审核实绩记录时

**消息主题格式**: `[실적 관리] {period} 실적이 {status}되었습니다`

**可能的状态**:
- `승인` - 批准
- `보완 요청` - 要求补充
- `거부` - 拒绝

**消息内容**:
```
{period} 실적 데이터가 {status}되었습니다.

관리자 의견: {comments}
```

**示例**:
- `[실적 관리] 2026년 1분기 실적이 승인되었습니다`
- `[실적 관리] 2026년 1분기 실적이 보완 요청되었습니다`
- `[실적 관리] 2026년 1분기 실적이 거부되었습니다`

**点击后跳转**: `/member/performance` (实绩管理页面)

**实现文件**: `backend/src/modules/performance/service.py`

---

### 2. 事业申请结果通知（未来）

**触发时机**: 管理员审核事业申请时

**消息主题格式**: `[사업 관리] {project_name} 신청이 {status}되었습니다`

**可能的状态**:
- `승인` - 批准
- `거부` - 拒绝
- `보류` - 保留

**点击后跳转**: `/member/projects` (事业公告页面)

**实现文件**: `backend/src/modules/project/service.py`

**状态**: ✅ 已实现

---

### 3. 会员资料审核通知（未来）

**触发时机**: 管理员审核会员注册或资料变更时

**消息主题格式**: `[회원 관리] 회원 {action}이 {status}되었습니다`

**可能的操作**:
- `가입` - 注册
- `정보 수정` - 信息修改

**点击后跳转**: `/member/profile` (会员资料页面)

**实现文件**: `backend/src/modules/member/service.py`

**状态**: ✅ 已实现

---

### 4. 系统通知（未来）

**触发时机**: 系统维护、重要公告等

**消息主题格式**: 自定义

**示例**:
- `시스템 정기 점검 안내`
- `새로운 지원 사업 공고`
- `중요 공지사항`

**点击后跳转**: `/member/support/inquiry-history` (咨询历史页面)

**状态**: 🔄 待实现

---

## 通知显示规则

### 通知铃铛

- **位置**: 页面右上角
- **徽章**: 红色背景，显示未读数量
- **刷新**: 每 1 分钟自动刷新
- **初始加载**: 页面加载时立即显示

### 通知列表

点击铃铛后显示下拉列表：
- 最多显示 10 条最新通知
- 按时间倒序排列
- 未读消息有蓝色背景高亮
- 显示消息主题、内容预览、时间

### 通知状态

- **未读**: 蓝色信封图标 + 蓝色圆点
- **已读**: 灰色打开信封图标

---

## 智能跳转逻辑

### 跳转规则

系统根据消息主题中的关键词自动判断跳转目标：

| 关键词 | 跳转页面 | 路径 |
|--------|---------|------|
| `[실적 관리]`, `실적`, `성과` | 实绩管理 | `/member/performance` |
| `[사업 관리]`, `사업`, `지원` | 事业公告 | `/member/projects` |
| `[회원 관리]`, `회원` | 会员资料 | `/member/profile` |
| 其他 | 咨询历史 | `/member/support/inquiry-history` |

### 跳转流程

1. 用户点击通知
2. 系统自动标记为已读
3. 未读数量自动更新
4. 根据关键词跳转到对应页面
5. 关闭通知下拉框

---

## 线程消息 vs 直接消息

### 线程消息

- **来源**: 管理员在咨询对话中的回复
- **显示**: 通知列表中显示"管理员已回复"
- **点击**: 打开对话框 (Modal)，可以直接回复
- **标记已读**: 打开对话框时自动标记

### 直接消息

- **来源**: 系统自动发送
- **显示**: 通知列表中显示完整主题和内容预览
- **点击**: 跳转到相关功能页面
- **标记已读**: 点击时自动标记

---

## 通知优先级（未来）

### 重要通知

带有红色"重要"标签的通知：
- 实绩被拒绝
- 申请被拒绝
- 账号异常
- 紧急系统通知

### 普通通知

不带特殊标签的通知：
- 实绩批准
- 实绩要求补充
- 申请批准
- 一般系统通知

---

## 通知历史

### 查看所有通知

点击"查看全部"按钮跳转到咨询历史页面：
- 路径: `/member/support/inquiry-history`
- 显示所有历史通知
- 支持筛选和搜索
- 支持批量标记已读

### 通知保留

- 通知永久保留，不会自动删除
- 用户可以手动删除不需要的通知
- 已删除的通知不会再显示

---

## 前端实现

### 组件

- **NotificationBell.jsx** - 通知铃铛组件
  - 显示未读数量徽章
  - 下拉通知列表
  - 处理点击事件
  - 自动刷新

### 服务

- **messages.service.js** - 消息服务
  - `getMemberMessages()` - 获取消息列表
  - `getMemberUnreadCount()` - 获取未读数量
  - `markAsRead()` - 标记为已读

### 路由

智能跳转根据消息主题自动选择目标页面。

---

## 后端实现

### 发送通知

```python
from modules.messages.service import service as message_service
from modules.messages.schemas import MessageCreate
from uuid import UUID

await message_service.create_direct_message(
    sender_id=None,  # 系统发送
    recipient_id=UUID(member_id),
    data=MessageCreate(
        subject="[실적 관리] 2026년 1분기 실적이 승인되었습니다",
        content="2026년 1분기 실적 데이터가 승인되었습니다.",
        recipient_id=UUID(member_id),
    ),
)
```

### 消息字段

- `message_type`: `'direct'` - 直接消息
- `sender_type`: `'system'` - 系统发送
- `recipient_id`: 会员 ID
- `subject`: 消息主题（包含分类前缀）
- `content`: 消息内容
- `is_read`: 是否已读
- `created_at`: 创建时间

---

## 测试场景

### 1. 实绩审核通知测试

1. 会员提交实绩记录
2. 管理员审核实绩（批准/要求补充/拒绝）
3. 会员登录，检查通知铃铛
4. 点击通知，确认跳转到实绩管理页面
5. 确认通知被标记为已读

### 2. 多条通知测试

1. 触发多个不同类型的通知
2. 检查通知列表按时间排序
3. 检查未读数量正确
4. 逐个点击通知，确认跳转正确

### 3. 自动刷新测试

1. 打开会员页面
2. 在另一个浏览器中触发通知
3. 等待 1 分钟
4. 确认通知铃铛自动更新

---

## 相关文件

### 前端

- `frontend/src/shared/components/NotificationBell.jsx`
- `frontend/src/shared/services/messages.service.js`

### 后端

- `backend/src/modules/performance/service.py` - 实绩通知
- `backend/src/modules/messages/service.py` - 消息服务
- `backend/src/common/modules/supabase/message_service.py` - 数据库操作

### 文档

- `docs/requirements/active/notification-bell-fix-summary.md` - 通知铃铛修复总结
- `docs/requirements/active/admin-notifications-implementation.md` - 管理员通知实现
- `docs/requirements/active/member-notifications-guide.md` - 本文档

---

## 未来扩展

### 建议添加的通知

1. **事业申请结果通知** - 申请批准/拒绝时通知会员
2. **会员资料审核通知** - 注册批准/拒绝时通知会员
3. **文档审核通知** - 上传的文档审核结果
4. **支付通知** - 支付成功/失败通知
5. **活动通知** - 新活动、讲座、培训通知

### 通知偏好设置

允许会员设置通知偏好：
- 选择接收哪些类型的通知
- 设置通知方式（站内信、邮件）
- 设置免打扰时间段

### 通知分组

按类型分组显示通知：
- 实绩相关
- 事业相关
- 系统通知
- 其他

---

## 状态

✅ **已完成** - 2025-01-31

**实现的功能**:
- ✅ 实绩审核结果通知
- ✅ 智能跳转到对应功能页面
- ✅ 自动标记已读
- ✅ 通知铃铛实时显示
- ✅ 自动刷新未读数量

**待实现的功能**:
- 🔄 系统公告通知
- 🔄 通知偏好设置
- 🔄 系统公告通知
- 🔄 通知偏好设置
