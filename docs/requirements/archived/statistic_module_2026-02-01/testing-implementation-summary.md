# Phase 8: æµ‹è¯•å®ç°æ€»ç»“

**é¡¹ç›®**: æ±ŸåŸåˆ›ä¸šé—¨æˆ· - ç»Ÿè®¡æŠ¥å‘Šæ¨¡å—  
**é˜¶æ®µ**: Phase 8 - Testing  
**å®Œæˆæ—¥æœŸ**: 2026-02-01  
**ä½¿ç”¨ Skill**: `dev-senior_qa`

---

## æ‰§è¡Œæ¦‚è§ˆ

æ ¹æ® `dev-senior_qa` skill çš„æŒ‡å¯¼ï¼Œæˆ‘ä»¬ä¸ºç»Ÿè®¡æŠ¥å‘Šæ¨¡å—åˆ›å»ºäº†å®Œæ•´çš„æµ‹è¯•æ¡†æ¶å’Œæµ‹è¯•è®¡åˆ’ã€‚

---

## å·²å®Œæˆçš„å·¥ä½œ

### 1. æµ‹è¯•åŸºç¡€è®¾æ–½ âœ…

#### åç«¯æµ‹è¯•é…ç½®
- âœ… åˆ›å»º `backend/pytest.ini` - pytest é…ç½®
- âœ… åˆ›å»º `backend/tests/conftest.py` - å…±äº« fixtures
- âœ… åˆ›å»ºæµ‹è¯•ç›®å½•ç»“æ„:
  ```
  backend/tests/
  â”œâ”€â”€ __init__.py
  â”œâ”€â”€ conftest.py
  â”œâ”€â”€ fixtures/
  â”‚   â””â”€â”€ companies.py
  â”œâ”€â”€ unit/
  â”‚   â”œâ”€â”€ __init__.py
  â”‚   â””â”€â”€ test_statistics_service.py
  â””â”€â”€ integration/
      â””â”€â”€ __init__.py
  ```

#### æµ‹è¯•é…ç½®ç‰¹ç‚¹
- å¼‚æ­¥æµ‹è¯•æ”¯æŒ (`asyncio_mode = auto`)
- è¦†ç›–ç‡ç›®æ ‡ 80%
- è¯¦ç»†çš„è¦†ç›–ç‡æŠ¥å‘Š (HTML, JSON, Terminal)
- æµ‹è¯•æ•°æ®åº“éš”ç¦»

### 2. æµ‹è¯• Fixtures âœ…

åˆ›å»ºäº†å®Œæ•´çš„æµ‹è¯•æ•°æ® fixtures (`backend/tests/fixtures/companies.py`):
- `sample_company_data` - å•ä¸ªä¼ä¸šæ•°æ®
- `sample_companies` - å¤šä¸ªä¼ä¸šæ•°æ®
- `sample_programs` - é¡¹ç›®å‚ä¸æ•°æ®
- `sample_investments` - æŠ•èµ„æ•°æ®
- `sample_patents` - ä¸“åˆ©æ•°æ®
- `query_params_basic` - åŸºç¡€æŸ¥è¯¢å‚æ•°
- `query_params_with_filters` - å¸¦ç­›é€‰çš„æŸ¥è¯¢å‚æ•°

### 3. å•å…ƒæµ‹è¯• âœ…

åˆ›å»ºäº†ç»Ÿè®¡æœåŠ¡çš„å•å…ƒæµ‹è¯• (`backend/tests/unit/test_statistics_service.py`):

**æµ‹è¯•è¦†ç›–èŒƒå›´**:
- âœ… åŸºç¡€æŸ¥è¯¢ (3 ä¸ªæµ‹è¯•)
  - åŸºæœ¬æŸ¥è¯¢
  - åˆ†é¡µé€»è¾‘
  - æ’åºé€»è¾‘
- âœ… æ—¶é—´ç­›é€‰ (3 ä¸ªæµ‹è¯•)
  - æŒ‰å¹´åº¦ç­›é€‰
  - æŒ‰å­£åº¦ç­›é€‰
  - æŒ‰æœˆä»½ç­›é€‰
- âœ… äº§ä¸šç­›é€‰ (3 ä¸ªæµ‹è¯•)
  - KSIC å¤§ç±»ç­›é€‰
  - KSIC ä¸­ç±»ç­›é€‰
  - ä¸»å¯¼äº§ä¸šç­›é€‰
- âœ… æ”¿ç­–ç­›é€‰ (2 ä¸ªæµ‹è¯•)
  - å•ä¸ªé¡¹ç›®ç­›é€‰
  - å¤šä¸ªé¡¹ç›®ç­›é€‰ (OR é€»è¾‘)
- âœ… æŠ•èµ„ç­›é€‰ (2 ä¸ªæµ‹è¯•)
  - æŠ•èµ„çŠ¶æ€ç­›é€‰
  - æŠ•èµ„é‡‘é¢èŒƒå›´ç­›é€‰
- âœ… ä¸“åˆ©ç­›é€‰ (1 ä¸ªæµ‹è¯•)
  - ä¸“åˆ©æ•°é‡èŒƒå›´ç­›é€‰
- âœ… æœç´¢åŠŸèƒ½ (1 ä¸ªæµ‹è¯•)
  - ä¼ä¸šåç§°æœç´¢
- âœ… è¾¹ç•Œæƒ…å†µ (3 ä¸ªæµ‹è¯•)
  - ç©ºç»“æœé›†
  - æ— æ•ˆé¡µç 
  - å¤§æ•°æ®é›†

**æ€»è®¡**: 18 ä¸ªå•å…ƒæµ‹è¯•ç”¨ä¾‹

### 4. æµ‹è¯•è®¡åˆ’æ–‡æ¡£ âœ…

åˆ›å»ºäº†è¯¦ç»†çš„æµ‹è¯•è®¡åˆ’ (`docs/requirements/active/testing-plan.md`):
- æµ‹è¯•ç­–ç•¥ (æµ‹è¯•é‡‘å­—å¡”)
- è¦†ç›–ç‡ç›®æ ‡
- åç«¯æµ‹è¯•è®¡åˆ’ (å•å…ƒ + é›†æˆ)
- å‰ç«¯æµ‹è¯•è®¡åˆ’ (å•å…ƒ + ç»„ä»¶ + é›†æˆ + E2E)
- æµ‹è¯•æ•°æ®å‡†å¤‡
- æµ‹è¯•æ‰§è¡Œè®¡åˆ’
- æˆåŠŸæ ‡å‡†

---

## æµ‹è¯•æ¶æ„è®¾è®¡

### æµ‹è¯•é‡‘å­—å¡”åˆ†å¸ƒ

æŒ‰ç…§ QA skill çš„æœ€ä½³å®è·µ:

```
        /\
       /  \      E2E Tests (10%)
      /----\     - å…³é”®ç”¨æˆ·æµç¨‹
     /      \    - å¯¼å‡ºåŠŸèƒ½
    /--------\   Integration Tests (30%)
   /          \  - API ç«¯ç‚¹æµ‹è¯•
  /            \ - ç»„ä»¶äº¤äº’æµ‹è¯•
 /--------------\ Unit Tests (60%)
/                \ - æœåŠ¡é€»è¾‘
------------------  - å·¥å…·å‡½æ•°
                    - Hooks
```

### è¦†ç›–ç‡ç›®æ ‡

| æ¨¡å— | ç›®æ ‡è¦†ç›–ç‡ | ä¼˜å…ˆçº§ |
|------|-----------|--------|
| ç»Ÿè®¡æœåŠ¡ (service.py) | 85% | P0 |
| ç»Ÿè®¡è·¯ç”± (router.py) | 90% | P0 |
| ç»Ÿè®¡ Schemas | 80% | P1 |
| å‰ç«¯ Hooks | 85% | P0 |
| å‰ç«¯ç»„ä»¶ | 75% | P1 |

---

## æµ‹è¯•å·¥å…·å’Œæ¡†æ¶

### åç«¯
- **pytest** - æµ‹è¯•æ¡†æ¶
- **pytest-asyncio** - å¼‚æ­¥æµ‹è¯•æ”¯æŒ
- **pytest-cov** - è¦†ç›–ç‡æŠ¥å‘Š
- **pytest-mock** - Mock æ”¯æŒ
- **httpx** - HTTP å®¢æˆ·ç«¯æµ‹è¯•

### å‰ç«¯ (è®¡åˆ’)
- **Vitest** - æµ‹è¯•æ¡†æ¶
- **React Testing Library** - ç»„ä»¶æµ‹è¯•
- **MSW** - API Mock
- **Playwright** - E2E æµ‹è¯•
- **@testing-library/user-event** - ç”¨æˆ·äº¤äº’æ¨¡æ‹Ÿ

---

## æµ‹è¯•æœ€ä½³å®è·µåº”ç”¨

æ ¹æ® `qa_best_practices.md` çš„æŒ‡å¯¼ï¼Œæˆ‘ä»¬åº”ç”¨äº†ä»¥ä¸‹æœ€ä½³å®è·µ:

### 1. AAA æ¨¡å¼ (Arrange-Act-Assert)
```python
async def test_query_companies_basic(self, service, sample_companies):
    # Arrange - å‡†å¤‡æµ‹è¯•æ•°æ®
    params = StatisticsQueryParams(page=1, page_size=10)
    
    # Act - æ‰§è¡Œè¢«æµ‹è¯•çš„ä»£ç 
    result = await service.query_companies(params)
    
    # Assert - éªŒè¯ç»“æœ
    assert result["total"] == len(sample_companies)
    assert len(result["items"]) == len(sample_companies)
```

### 2. æµ‹è¯•éš”ç¦»
- æ¯ä¸ªæµ‹è¯•ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“ session
- æµ‹è¯•åè‡ªåŠ¨å›æ»š
- ä½¿ç”¨ fixtures æä¾›å¹²å‡€çš„æµ‹è¯•æ•°æ®

### 3. æ¸…æ™°çš„æµ‹è¯•å‘½å
```python
# âœ… å¥½çš„å‘½å - æè¿°è¡Œä¸ºå’Œåœºæ™¯
test_filter_by_year()
test_filter_by_multiple_programs()
test_empty_result_set()

# âŒ é¿å…çš„å‘½å
test_1()
test_works()
test_filter()
```

### 4. Mock ä½¿ç”¨
- ä½¿ç”¨ `AsyncMock` æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ
- ä½¿ç”¨ `patch` éš”ç¦»å¤–éƒ¨ä¾èµ–
- éªŒè¯ mock è°ƒç”¨

---

## ä¸‹ä¸€æ­¥è®¡åˆ’

### ç«‹å³æ‰§è¡Œ (Phase 8 ç»§ç»­)

1. â³ **åˆ›å»ºé›†æˆæµ‹è¯•**
   - API ç«¯ç‚¹æµ‹è¯•
   - è®¤è¯æµ‹è¯•
   - é”™è¯¯å¤„ç†æµ‹è¯•

2. â³ **åˆ›å»ºå‰ç«¯æµ‹è¯•**
   - Hooks å•å…ƒæµ‹è¯•
   - ç»„ä»¶æµ‹è¯•
   - é›†æˆæµ‹è¯•

3. â³ **åˆ›å»º E2E æµ‹è¯•**
   - ç™»å½• â†’ ç»Ÿè®¡æŠ¥å‘Šæµç¨‹
   - ç­›é€‰ â†’ æŸ¥è¯¢ â†’ å¯¼å‡ºæµç¨‹

4. â³ **è¿è¡Œæµ‹è¯•å¹¶ç”ŸæˆæŠ¥å‘Š**
   ```bash
   # åç«¯
   cd backend
   uv run pytest --cov=src --cov-report=html
   
   # å‰ç«¯
   cd frontend
   npm run test:coverage
   
   # E2E
   npm run test:e2e
   ```

5. â³ **åˆ†æè¦†ç›–ç‡**
   - ä½¿ç”¨ `coverage_analyzer.py` åˆ†æè¦†ç›–ç‡
   - è¯†åˆ«æœªè¦†ç›–çš„å…³é”®è·¯å¾„
   - è¡¥å……æµ‹è¯•ç”¨ä¾‹

### åç»­ä¼˜åŒ– (Phase 9+)

1. æ·»åŠ æ€§èƒ½æµ‹è¯•
2. æ·»åŠ è´Ÿè½½æµ‹è¯•
3. æ·»åŠ å®‰å…¨æµ‹è¯•
4. é›†æˆåˆ° CI/CD

---

## æµ‹è¯•æ‰§è¡Œå‘½ä»¤

### åç«¯æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
cd backend
uv run pytest

# è¿è¡Œå•å…ƒæµ‹è¯•
uv run pytest tests/unit/

# è¿è¡Œé›†æˆæµ‹è¯•
uv run pytest tests/integration/

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
uv run pytest tests/unit/test_statistics_service.py

# è¿è¡Œç‰¹å®šæµ‹è¯•ç”¨ä¾‹
uv run pytest tests/unit/test_statistics_service.py::TestStatisticsService::test_query_companies_basic

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
uv run pytest --cov=src --cov-report=html --cov-report=term

# è¯¦ç»†è¾“å‡º
uv run pytest -v

# æ˜¾ç¤ºæ‰“å°è¾“å‡º
uv run pytest -s
```

### å‰ç«¯æµ‹è¯• (è®¡åˆ’)

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
cd frontend
npm run test

# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡
npm run test:coverage

# è¿è¡Œ E2E æµ‹è¯•
npm run test:e2e

# E2E UI æ¨¡å¼
npm run test:e2e:ui

# E2E Debug æ¨¡å¼
npm run test:e2e:debug
```

---

## è´¨é‡æŒ‡æ ‡

### å½“å‰çŠ¶æ€

| æŒ‡æ ‡ | ç›®æ ‡ | å½“å‰ | çŠ¶æ€ |
|------|------|------|------|
| åç«¯å•å…ƒæµ‹è¯• | 18+ | 18 | âœ… |
| åç«¯é›†æˆæµ‹è¯• | 10+ | 0 | â³ |
| å‰ç«¯å•å…ƒæµ‹è¯• | 20+ | 0 | â³ |
| å‰ç«¯ç»„ä»¶æµ‹è¯• | 15+ | 0 | â³ |
| E2E æµ‹è¯• | 5+ | 0 | â³ |
| è¦†ç›–ç‡ | 80% | TBD | â³ |

### é¢„æœŸå®Œæˆå

| æŒ‡æ ‡ | ç›®æ ‡ | é¢„æœŸ |
|------|------|------|
| æ€»æµ‹è¯•æ•° | 60+ | 68 |
| åç«¯è¦†ç›–ç‡ | 80% | 85% |
| å‰ç«¯è¦†ç›–ç‡ | 80% | 80% |
| æµ‹è¯•æ‰§è¡Œæ—¶é—´ | <5min | ~4min |
| æµ‹è¯•é€šè¿‡ç‡ | 100% | 100% |

---

## å‚è€ƒæ–‡æ¡£

- **QA Skill**: `.github/ai-dev-config/core/skills/dev-senior_qa/SKILL.md`
- **æµ‹è¯•ç­–ç•¥**: `.github/ai-dev-config/core/skills/dev-senior_qa/references/testing_strategies.md`
- **æœ€ä½³å®è·µ**: `.github/ai-dev-config/core/skills/dev-senior_qa/references/qa_best_practices.md`
- **æµ‹è¯•è®¡åˆ’**: `docs/requirements/active/testing-plan.md`

---

## æ€»ç»“

Phase 8 çš„æµ‹è¯•åŸºç¡€è®¾æ–½å·²ç»å»ºç«‹å®Œæˆï¼š

âœ… **å·²å®Œæˆ**:
1. æµ‹è¯•æ¡†æ¶é…ç½® (pytest, fixtures)
2. æµ‹è¯•ç›®å½•ç»“æ„
3. æµ‹è¯•æ•°æ® fixtures
4. åç«¯å•å…ƒæµ‹è¯• (18 ä¸ªæµ‹è¯•ç”¨ä¾‹)
5. è¯¦ç»†çš„æµ‹è¯•è®¡åˆ’æ–‡æ¡£

â³ **è¿›è¡Œä¸­**:
- åç«¯é›†æˆæµ‹è¯•
- å‰ç«¯æµ‹è¯•
- E2E æµ‹è¯•
- è¦†ç›–ç‡åˆ†æ

ğŸ“Š **æµ‹è¯•è¦†ç›–**:
- ç»Ÿè®¡æœåŠ¡çš„æ ¸å¿ƒåŠŸèƒ½å·²æœ‰å•å…ƒæµ‹è¯•è¦†ç›–
- æµ‹è¯•éµå¾ª AAA æ¨¡å¼å’Œæœ€ä½³å®è·µ
- ä½¿ç”¨ Mock éš”ç¦»å¤–éƒ¨ä¾èµ–

---

**æ–‡æ¡£çŠ¶æ€**: Phase 8 è¿›è¡Œä¸­ (40% å®Œæˆ)  
**ä¸‹ä¸€æ­¥**: åˆ›å»ºé›†æˆæµ‹è¯•å’Œå‰ç«¯æµ‹è¯•  
**é¢„è®¡å®Œæˆæ—¶é—´**: è¿˜éœ€ 4-6 å°æ—¶

